---
- name: Check if application directory exists
  stat:
    path: "{{ app_dir }}"
  register: app_dir_stat

- name: Clone application repository
  git:
    repo: "{{ github_repo }}"
    dest: "{{ app_dir }}"
    version: main
    force: yes
  become_user: ubuntu
  when: not app_dir_stat.stat.exists

- name: Pull latest changes from repository
  git:
    repo: "{{ github_repo }}"
    dest: "{{ app_dir }}"
    version: main
    force: yes
  become_user: ubuntu
  when: app_dir_stat.stat.exists

- name: Ensure .env file exists with correct values
  copy:
    dest: "{{ app_dir }}/.env"
    content: |
      # Domain & SSL
      DOMAIN={{ domain_name }}
      EMAIL_ADDRESS={{ email_address }}
      
      # JWT Secret (shared across services)
      JWT_SECRET=myfancysecret
      
      # Redis Configuration
      REDIS_HOST=redis-queue
      REDIS_PORT=6379
      REDIS_CHANNEL=log_channel
      
      # Frontend
      PORT=8080
      AUTH_API_ADDRESS=http://auth-api:8081
      TODOS_API_ADDRESS=http://todos-api:8082
      
      # Auth API
      AUTH_API_PORT=8081
      USERS_API_ADDRESS=http://users-api:8083
      
      # Users API
      SERVER_PORT=8083
    owner: ubuntu
    group: ubuntu
    mode: '0644'

- name: Stop existing containers
  command: docker-compose down
  args:
    chdir: "{{ app_dir }}"
  become_user: ubuntu
  ignore_errors: yes

- name: Remove only stopped containers and dangling images
  command: docker system prune -f
  become_user: ubuntu
  ignore_errors: yes

- name: Pull base images first
  command: docker-compose pull
  args:
    chdir: "{{ app_dir }}"
  become_user: ubuntu
  ignore_errors: yes

- name: Build and start Docker containers
  command: docker-compose up -d --build --remove-orphans
  args:
    chdir: "{{ app_dir }}"
  become_user: ubuntu
  register: compose_output
  retries: 3
  delay: 10
  until: compose_output.rc == 0

- name: Wait for services to be healthy
  pause:
    seconds: 45

- name: Check running containers
  command: docker ps -a
  register: docker_ps
  changed_when: false

- name: Display running containers
  debug:
    var: docker_ps.stdout_lines

- name: Verify all expected containers are running
  shell: |
    echo "Checking container health..."
    EXPECTED=("traefik" "frontend" "auth-api" "todos-api" "users-api" "redis-queue" "log-processor")
    
    for container in "${EXPECTED[@]}"; do
      if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
        STATUS=$(docker inspect --format='{{.State.Status}}' $container)
        echo "✅ $container: $STATUS"
      else
        echo "❌ $container: NOT FOUND"
      fi
    done
  register: health_check
  changed_when: false
  ignore_errors: yes

- name: Display health check results
  debug:
    var: health_check.stdout_lines

- name: Get container logs if any failed
  shell: |
    echo "=== Checking for failed containers ==="
    for container in $(docker ps -a --filter "status=exited" --format "{{.Names}}"); do
      echo "--- Logs for $container ---"
      docker logs $container --tail 50
    done
  register: failed_logs
  changed_when: false
  ignore_errors: yes
  when: compose_output.rc != 0

- name: Display failed container logs
  debug:
    var: failed_logs.stdout_lines
  when: compose_output.rc != 0